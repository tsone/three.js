<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - particles - gpu</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				background-color: #ffffff;
				margin: 0px;
				overflow: hidden;
				font-family:Monospace;
				font-size:13px;
				text-align:center;
				text-align:center;
				cursor: pointer;
			}

			a {
				color:#0078ff;
			}

			#info {
				color: #fff;
				position: absolute;
				top: 10px;
				width: 100%;
			}

		</style>
	</head>
	<body>

		<div id="info">
			<a href="http://threejs.org" target="_blank">three.js</a> - <span id="particles"></span> webgl - particles - gpu<br/>
			gpu particle system with collision planes<br/>
			select <span id="options"></span> particles<br/>

		</div>

		<script src="../build/three.min.js"></script>
		<script src="js/Detector.js"></script>
		<script src="js/libs/stats.min.js"></script>

		<script src="js/gpuparticles/GPUParticleGeometry.js"></script>
		<script src="js/gpuparticles/GPUParticleSystem.js"></script>
		<script src="js/gpuparticles/GPUParticleEmitter.js"></script>

		<script>

			if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

			var hash = document.location.hash.substr( 1 );
			if (hash) hash = parseInt(hash, 0);

			var SIZE = hash || 32;
			var PARTICLES = SIZE * SIZE;

			var container, stats;
			var camera, scene, renderer, i, h, color;
			var mouseX = 0, mouseY = 0;
			var angleX = 0, angleY = 0;

			var windowHalfX = window.innerWidth / 2;
			var windowHalfY = window.innerHeight / 2;

			var particleSystem;

			var testEmitters = [];

			document.getElementById('particles').innerText = PARTICLES;

			function change(n) {
				location.hash = n;
				location.reload();
				return false;
			}

			var options = '';
			for (i=1; i<7; i++) {
				var j = Math.pow(2, i);
				options += '<a href="#" onclick="return change(' + j + ')">' + (j * j) + '</a> ';
			}
			document.getElementById('options').innerHTML = options;


			init();
			animate();

			function init() {

				container = document.createElement( 'div' );
				document.body.appendChild( container );

				renderer = new THREE.WebGLRenderer();
				renderer.antialias = false;
				renderer.sortObjects = false;
				renderer.autoClear = false;
				renderer.autoClearColor = renderer.autoClearDepth = renderer.autoClearStencil = false;
				renderer.setClearColor( 0x000000, 1 );
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );

				container.appendChild( renderer.domElement );

				camera = new THREE.PerspectiveCamera( 55, window.innerWidth / window.innerHeight, 1, 300 );
				camera.position.y = 40;
				camera.position.z = 100;
				camera.rotation.x = -0.5;

				scene = new THREE.Scene();

				// Init particle system.

				var particleTex = THREE.ImageUtils.loadTexture( "textures/sprites/circle.png" );
				particleTex.minFilter = particleTex.magFilter = THREE.LinearFilter;

				testEmitters[ 0 ] = new THREE.GPUParticleEmitter( {
					velocityZ: -1,
					velocityRandom: [ 0.1, 0.1, 0.5 ]
				} );
				testEmitters[ 0 ].position.y = 30;
				testEmitters[ 0 ].scale.z = 3;
				testEmitters[ 0 ].burstSize = 1;
				scene.add( testEmitters[ 0 ] );

				testEmitters[ 1 ] = new THREE.GPUParticleEmitter( {
					velocityZ: -1,
					velocityRandom: [ 0, 0, 0 ]
				} );
				testEmitters[ 1 ].position.y = 30;
				testEmitters[ 1 ].rotation.x = -0.5 * 3.14;
				testEmitters[ 1 ].scale.set( 20, 20, 1 );
				testEmitters[ 1 ].burstSize = 2;
				scene.add( testEmitters[ 1 ] );

				var planeData = [
					 0, 1, 0, 30,	// Floor plane (-Y)
					 1, 0, 0, 50,	// -X wall
					-1, 0, 0, 50,	// +X wall
					 0, 0, 1, 50,	// -Z wall
					 0, 0,-1, 50	// +Z wall
				];
				var capsuleData = [
					// Two capsules lying on the floor in an X-shape.
					-25, -31, -25, 9, 25, -31,  25, 0,
					-25, -31,  25, 9, 25, -31, -25, 0
				];
				particleSystem = new THREE.GPUParticleSystem( SIZE, renderer, particleTex, {
					planeData: planeData,
					capsuleData: capsuleData,
					emitters: testEmitters
				} );

				scene.add( particleSystem );
				particleSystem.init();

				//

				stats = new Stats();
				stats.domElement.style.position = 'absolute';
				stats.domElement.style.top = '0px';
				container.appendChild( stats.domElement );

				document.addEventListener( 'mousemove', onDocumentMouseMove, false );
				document.addEventListener( 'touchstart', onDocumentTouchStart, false );
				document.addEventListener( 'touchmove', onDocumentTouchMove, false );

				window.addEventListener( 'resize', onWindowResize, false );

			}

			function onWindowResize() {

				windowHalfX = window.innerWidth / 2;
				windowHalfY = window.innerHeight / 2;

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}

			function onDocumentMouseMove( event ) {

				mouseX = event.clientX - windowHalfX;
				mouseY = event.clientY - windowHalfY;

			}

			function onDocumentTouchStart( event ) {

				if ( event.touches.length === 1 ) {

					event.preventDefault();

					mouseX = event.touches[ 0 ].pageX - windowHalfX;
					mouseY = event.touches[ 0 ].pageY - windowHalfY;

				}

			}

			function onDocumentTouchMove( event ) {

				if ( event.touches.length === 1 ) {

					event.preventDefault();

					mouseX = event.touches[ 0 ].pageX - windowHalfX;
					mouseY = event.touches[ 0 ].pageY - windowHalfY;

				}

			}

			function animate() {

				requestAnimationFrame( animate );
				render();
				stats.update();

			}

			function render() {

				var t = Date.now() / 1000;

				angleX += (  0.5*Math.PI * mouseX / window.innerWidth - angleX ) * 0.05;
//				angleY += (  0.5*Math.PI * mouseY / window.innerHeight - angleY ) * 0.05;

				var r = 100;
//				camera.position.x = r * Math.sin(angleX) * Math.cos(angleY);
//				camera.position.y = r * Math.sin(angleY);
//				camera.position.z = -r * Math.cos(angleX) * Math.cos(angleY);
				camera.position.x = r * Math.sin(angleX);
				camera.position.y = 40;
				camera.position.z = -r * Math.cos(angleX);

				camera.lookAt( scene.position );

				testEmitters[ 0 ].position.x = 30 * Math.cos( t );
				testEmitters[ 0 ].position.z = 30 * Math.sin( t );
				testEmitters[ 0 ].lookAt( scene.position );

				testEmitters[ 1 ].position.x = - testEmitters[ 0 ].position.x;
				testEmitters[ 1 ].position.z = - testEmitters[ 0 ].position.z;

				particleSystem.step();
				renderer.render( scene, camera );

			}

		</script>
	</body>
</html>
